03_qoes = {
    header = "lotr_rohan_mission_header"
    icon = "lotr_aimordor_mission_icon"

    repeatable = no
    chance = 1000

    potential = {
        NOT = { has_variable = mission_cooldown_var }
        tag = SR4
    }

    abort = {}
    on_start = {
        start_mission_ai_effect = yes
    }
    on_abort = {
        custom_tooltip = general_mission_cooldown_tt
        set_variable = {
            name = mission_cooldown_var
            days = 7300
        }
    }
    on_completion = {
        capital_scope = {
            capital_formable_medium_effect = yes
        }
    }

    03_qoes_task_1 = {
        icon = "task_battle"
        requires = {03_qoes_task_8}
        duration = 30
        highlight = {
            scope:province = {
            	is_in_area = shouth_skyreach_foothil_1
            }
        }
        allow = {
        	political_influence >= 15
        }
        on_completion = {
        	add_political_influence = -15
        	area:shouth_skyreach_foothil_1 = {
                add_provincial_claim_effect = yes
			}
            trigger_event = me_qoes.1
        }
    }

    03_qoes_task_2 = {
        icon = "task_conquest"
        requires = {03_qoes_task_8}
        duration = 30
        highlight = {
            scope:province = {
            	is_in_area = shouth_skyreach_foothil_2
            }
        }
        allow = {
        	capital_scope.state = {
				has_state_food <= 150
			}
        }
        on_completion = {
        	area:shouth_skyreach_foothil_2 = {
                add_provincial_claim_effect = yes
			}
            trigger_event = me_qoes.2
        }
    }
    03_qoes_task_3 = {
        icon = "task_expansion"
        requires = {03_qoes_task_1 03_qoes_task_2 03_qoes_task_6}
        highlight = {
            scope:province = {
            	OR = {
            		is_in_area = shouth_skyreach_foothil_1
            		is_in_area = shouth_skyreach_foothil_2
            	}
            }
        }
        allow = {
        	owns_percent_of_area = {
                PROVINCE = "p:3977" 
                PERCENT = "0.75"
            }
            owns_percent_of_area = {
                PROVINCE = "p:4067" 
                PERCENT = "0.75"
            }
        }
        on_completion = {
            custom_tooltip = western_skyreach_claims_tt
            custom_tooltip = eastern_skyreach_claims_tt
            add_military_experience = 20
            hidden:region:western_shout_skyreach_foothils = {
                    every_region_province = { add_claim = root }
                }
            hidden:region:eastern_shout_skyreach_foothils = {
                    every_region_province = { add_claim = root }
                }
            trigger_event = me_qoes.3
        }
    }
    03_qoes_task_4 = {
        icon = "task_apollo"
        requires = {03_qoes_task_7}
        duration = 180
        highlight = {
            scope:province = {
                 this = p:3816
            }
        }
        allow = {
            treasury >= 300
            capital_scope = {
                civilization_value >= 40
            }
        }
        on_completion = {
            add_treasury = -300
            create_country_treasure = {
                key = "treasure_qoes_armor_of_edis"
                icon = "chineseshield1"
                modifier = {
                    local_defensive = 0.1
                    garrison_size = 0.1
                }
            }
            trigger_event = me_qoes.4
        }
    }
    03_qoes_task_5 = {
        icon = "task_economical"
        highlight = {
            scope:province = {
                 this = p:3816
            }
        }
        allow = {
            capital_scope = {
                num_of_workshop_building = 3
                has_no_ongoing_construction = yes  
            }
            invention = build_time_inv
        }
        on_completion = {
            capital_scope = {
                add_permanent_province_modifier = {
                    name = cinnabar_mills_of_qoes
                    duration = -1
                }
            }
            trigger_event = me_qoes.5
        }
    }
    03_qoes_task_6 = {
        icon = "task_happiness"
        requires = {03_qoes_task_8}
        highlight = {
            scope:province = {
                 this = p:3816
            }
        }
        allow = {
            capital_scope = {
                has_building = forum_building
                has_building = commerce_building
                is_importing_trade_good = marble
                is_importing_trade_good = precious_metals
                has_no_ongoing_construction = yes 
            }
            custom_tooltip = {
                text = we_need_dwarven_fortifications_tech_tt
                has_military_bonus = skyreach_dwarf_path_2
            }
        }
        on_completion = {
            capital_scope = {
                add_permanent_province_modifier = {
                    name = grand_forum_of_badfurqorin
                    duration = -1
                }
                add_building_level = temple_building
            }
            trigger_event = me_qoes.6
        }
    }
    03_qoes_task_7 = {
        icon = "task_economical"
        requires = {03_qoes_task_5}
        allow = {
            custom_tooltip = {
                text = qoes_cinnabar_svalue_tt
                qoes_cinnabar_svalue >= 7
            }
        }
        on_completion = {
            add_innovation = 2
            add_2_free_province_investments = yes
            trigger_event = me_qoes.7
            p:3816 = {add_road_towards = 3960}
            p:3816 = {add_road_towards = 3961}
        }
    }
    03_qoes_task_8 = {
        icon = "task_political"
        highlight = {
            scope:province = {
                 this = p:3816
            }
        }
        allow = {
            has_law = recruit_from_nobles
            manpower >= 4
            capital_scope = {
                num_of_military_building >= 1
            }
        }
        on_completion = {
            add_country_modifier = {
                name = copper_dwarven_mercenary_initiative
                duration = 3650
            }
            current_ruler = {
                add_martial = 1
            }
            add_research = {
            technology = military_tech
            value = 15
            }
            trigger_event = me_qoes.8
        }
    }
    03_qoes_task_9 = {
        icon = "task_atlas"
        requires = {03_qoes_task_3 03_qoes_task_4}
        final = yes
        allow = {
            custom_tooltip = {
                text = you_need_to_form_copper_kingdom
                tag = CKD
            }
        }
        on_completion = {
            p:3816 = {
                set_city_status = city_metropolis
            }
            trigger_event = me_qoes.9
            show_as_tooltip = {

            }
        }
    }
    03_qoes_task_10 = {
        icon = "task_calm"
        bypass = {
            limit = {
                NOT = 
                    exists = treasure:treasure_skyreach_altar
                }
        }
        allow = {
             trigger_if = {
                limit = { exists = treasure:treasure_skyreach_altar }
                hidden:treasure:treasure_skyreach_altar = {
                    custom_tooltip = {
                        text = we_need_to_own_the_skyreach_altar_tt
                        ROOT = {
                            any_holy_site = {
                                province_deity = deity:omen_edis
                                any_province_treasure = {
                                    this = treasure:treasure_skyreach_altar
                                }
                            }
                        }
                    }
                }
            }
            trigger_else = {
                custom_tooltip = {
                    text = we_need_to_own_the_skyreach_altar_tt
                    always = no
                }
            }
        }
        on_completion = {
            add_country_modifier = {
                name = skyreach_altar_in_copper_kingdom_mod
                duration = -1
            }
            trigger_event = me_qoes.10
        }
    }

}